<!DOCTYPE html>
<html>
    <head>
        <title>AlphaPose - websocket demo</title>
        <style type="text/css">
          body {
            font-family:"Open Sans", verdana, sans-serif;
          }
          .layout {
            display: flex;
            justify-content: space-around;
          }
          canvas {
            border: 1px dashed grey
          }
        </style>
    </head>
    <body>
      <header class="layout">
        <h3 id="frameCount">Frames <span></span></h3>
        <h3 id="humansCount"><span></span> humans</h3>
      </header>
      <div class="layout">
        <textarea id="dump"></textarea>
        <canvas id="renderer"/>
      </div>

        <script>
            var LOG_FRAMES = false,
                RENDERER_WIDTH = 1920,
                RENDERER_HEIGHT = 960,
                SKELETON_LINES = [2,5,8,11,2,8,5,11,2,3,3,4,5,6,6,7,8,9,9,10,11,12,12,13],
                MAX = Math.max

              ws = new WebSocket("ws://127.0.0.1:8612/", 'json'),
              frameCount = 0,
              parsedFrame = {},
              counter = document.querySelector('#frameCount span'),
              humanCounter = document.querySelector('#humansCount span'),
              frameOutput = document.getElementById('dump'),
              renderer = document.getElementById('renderer'),
              colors = ['#001f3f', '#0074D9', '#7FDBFF', '#39CCCC', '#3D9970', '#2ECC40', '#01FF70', '#FFDC00', '#FF851B', '#FF4136', '#85144b', '#F012BE', '#B10DC9', '#111111', '#AAAAAA', '#DDDDDD'];

            renderer.width = RENDERER_WIDTH
            renderer.height = RENDERER_HEIGHT
            var ctx = renderer.getContext('2d')

            if(!LOG_FRAMES) {
              frameOutput.innerHTML = 'Set LOG_FRAMES to true to log socket data'
            }

            function onMessage (event) {
                parsedFrame = JSON.parse(event.data)
                counter.innerHTML = ++frameCount
                humanCounter.innerHTML = parsedFrame.humans.length
                if(LOG_FRAMES) {
                  frameOutput.innerHTML = event.data
                }

                ctx.clearRect(0, 0, RENDERER_WIDTH, RENDERER_HEIGHT);
                ctx.lineWidth = 4;
                parsedFrame.humans.forEach(drawHuman)
            };

            function drawHuman (human, index) {
              currentColor = colors[index]
              if (currentColor === undefined) {
                  currentColor = '#'+Math.floor(Math.random()*16777215).toString(16);
                  colors.push(currentColor)
              }

              var points = human.pose_keypoints_2d

              // Head
              var hp1 = [points[2*3], points[2*3+1]]
              var hp2 = [points[5*3], points[5*3+1]]
              var dx = hp2[0] - hp1[0]
              var dy = hp2[1] - hp1[1]
              var hRadius = MAX((dx > dy ? dx : dy) * 0.4, 2)
              ctx.beginPath()
              ctx.arc(points[0]>>0, points[1]>>0, hRadius>>0, 0, 2 * Math.PI, false);
              ctx.fillStyle = currentColor;
              ctx.fill();

              // Limbs
              var sp, ep;
              ctx.strokeStyle = currentColor;
              SKELETON_LINES.forEach((p, i) => {
                if(i%2 === 0) {
                  sp = SKELETON_LINES[i]
                  ep = SKELETON_LINES[i+1]
                  ctx.beginPath()
                  ctx.moveTo(points[sp*3]>>0, points[sp*3 + 1]>>0);
                  ctx.lineTo(points[ep*3]>>0, points[ep*3 + 1]>>0);
                  ctx.stroke();
                }
              })
            }

            ws.onmessage = onMessage

        </script>
    </body>
</html>
